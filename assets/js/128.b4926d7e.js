(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{406:function(s,t,a){"use strict";a.r(t);var e=a(13),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[s._v("#")]),s._v(" 日志")]),s._v(" "),t("p",[s._v("你可以使用 Elasticsearch 的应用程序日志来监视集群并诊断问题。如果将 Elasticsearch 作为服务运行，则日志的默认位置会因平台和安装方法而异：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Docker")]),s._v(" "),t("p",[s._v("在 "),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/installing_elasticsearch/docker.html"}},[s._v("Docker")]),s._v(" 上，日志消息进入控制台，由配置的 Docker 日志驱动程序处理。要访问日志，请运行 "),t("code",[s._v("docker logs")]),s._v("。")],1)]),s._v(" "),t("li",[t("p",[s._v("Debian（APT）")]),s._v(" "),t("p",[s._v("对于 "),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/installing_elasticsearch/debian.html"}},[s._v("Debian 安装")]),s._v("，Elasticsearch 将日志写入 "),t("code",[s._v("/var/log/electricsearch")]),s._v("。")],1)]),s._v(" "),t("li",[t("p",[s._v("RPM")]),s._v(" "),t("p",[s._v("对于 "),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/installing_elasticsearch/rpm.html"}},[s._v("RPM 安装")]),s._v("，Elasticsearch 将日志写入 "),t("code",[s._v("/var/log/lelasticsearch")]),s._v("。")],1)]),s._v(" "),t("li",[t("p",[s._v("macOS")]),s._v(" "),t("p",[s._v("对于 "),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/installing_elasticsearch/linux.html"}},[s._v("macOS .tar.gz")]),s._v(" 安装，Elasticsearch 将日志写入 "),t("code",[s._v("$ES_HOME/logs")]),s._v("。")],1),s._v(" "),t("p",[s._v("升级期间，"),t("code",[s._v("$ES_HOME")]),s._v(" 中的文件可能会被删除。在生产中，我们强烈建议你设置 "),t("code",[s._v("path.logs")]),s._v(" 以记录到 "),t("code",[s._v("$ES_HOME")]),s._v(" 之外的位置。参阅"),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/configuring_elasticsearch/import_elasticsearch_configuration.html#路径设置"}},[s._v("路径设置")]),s._v("。")],1)]),s._v(" "),t("li",[t("p",[s._v("Linux")]),s._v(" "),t("p",[s._v("对于 "),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/installing_elasticsearch/linux.html"}},[s._v("Linux .tar.gz")]),s._v(" 安装，Elasticsearch 将日志写入 "),t("code",[s._v("$ES_HOME/logs")]),s._v("。")],1),s._v(" "),t("p",[s._v("升级期间，"),t("code",[s._v("$ES_HOME")]),s._v(" 中的文件可能会被删除。在生产中，我们强烈建议你将 "),t("code",[s._v("path.logs")]),s._v(" 设置在 "),t("code",[s._v("$ES_HOME")]),s._v(" 之外的位置。参阅"),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/configuring_elasticsearch/import_elasticsearch_configuration.html#路径设置"}},[s._v("路径设置")]),s._v("。")],1)]),s._v(" "),t("li",[t("p",[s._v("Windows .zip")]),s._v(" "),t("p",[s._v("对于 "),t("a",{attrs:{href:"/set_up_elasticsearch/installing_elasticsearch/windows"}},[s._v("Windows .zip")]),s._v(" 安装，Elasticsearch 将日志写入 "),t("code",[s._v("%ES_HOME%\\logs")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("%ES_HOME%")]),s._v(" 中的文件可能在升级过程中被删除。在生产环境中，我们强烈建议你将 "),t("code",[s._v("path.logs")]),s._v(" 设置在 "),t("code",[s._v("%ES_HOME%")]),s._v(" 之外的位置。参阅"),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/configuring_elasticsearch/import_elasticsearch_configuration.html#路径设置"}},[s._v("路径设置")]),s._v("。")],1)])]),s._v(" "),t("p",[s._v("如果从命令行运行 Elasticsearch，Elasticearch 会将日志打印到标准输出（"),t("code",[s._v("stdout")]),s._v("）。")]),s._v(" "),t("h2",{attrs:{id:"日志配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志配置"}},[s._v("#")]),s._v(" 日志配置")]),s._v(" "),t("div",{staticClass:"custom-block danger"},[t("p",{staticClass:"custom-block-title"},[s._v("重要")]),s._v(" "),t("p",[s._v("Elastic 强烈建议使用默认提供的 Log4j 2 配置。")])]),s._v(" "),t("p",[s._v("Elasticsearch 使用 Log4j 2 进行日志记录。可以使用 "),t("code",[s._v("log4j2.properties")]),s._v(" 文件配置 Log4j 2。Elasticsearch 暴露了三个属性，"),t("code",[s._v("${sys:es.logs.base_path}")]),s._v("、"),t("code",[s._v("${sys:es.logs.cluster_name}")]),s._v(" 和  "),t("code",[s._v("${sys:es.logs.node_name}")]),s._v("，它们可以在配置文件中引用以确定日志文件的位置。属性 "),t("code",[s._v("${sys:es.logs.base_path}")]),s._v(" 会解析为日志目录，"),t("code",[s._v("${sys:es.logs.cluster_name}")]),s._v(" 会解析为集群名字（在默认配置中用作日志文件名的前缀），以及 "),t("code",[s._v("${sys:es.logs.node_name}")]),s._v(" 会解析为节点名字（如果显示设置了节点名字）。")]),s._v(" "),t("p",[s._v("例如，如果你的日志目录（"),t("code",[s._v("path.logs")]),s._v("）是 "),t("code",[s._v("/var/log/elasticsearch")]),s._v(" 且你的集群被命名为 "),t("code",[s._v("production")]),s._v(" 那么 "),t("code",[s._v("${sys:es.logs.base_path}")]),s._v(" 会解析为 "),t("code",[s._v("/var/log/elasticsearch")]),s._v("，并且 "),t("code",[s._v("${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}.log")]),s._v(" 会解析为 "),t("code",[s._v("/var/log/elasticsearch/production.log")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("######## Server JSON ############################")]),s._v("\nappender.rolling.type = RollingFile \nappender.rolling.name = rolling\nappender.rolling.fileName = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("_server.json \nappender.rolling.layout.type = ECSJsonLayout \nappender.rolling.layout.dataset = elasticsearch.server \nappender.rolling.filePattern = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("yyyy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("MM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%i.json.gz \nappender.rolling.policies.type = Policies\nappender.rolling.policies.time.type = TimeBasedTriggeringPolicy \nappender.rolling.policies.time.interval = 1 \nappender.rolling.policies.time.modulate = true \nappender.rolling.policies.size.type = SizeBasedTriggeringPolicy \nappender.rolling.policies.size.size = 256MB \nappender.rolling.strategy.type = DefaultRolloverStrategy\nappender.rolling.strategy.fileIndex = nomax\nappender.rolling.strategy.action.type = Delete \nappender.rolling.strategy.action.basepath = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nappender.rolling.strategy.action.condition.type = IfFileName \nappender.rolling.strategy.action.condition.glob = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("* \nappender.rolling.strategy.action.condition.nested_condition.type = IfAccumulatedFileSize \nappender.rolling.strategy.action.condition.nested_condition.exceeds = 2GB \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("################################################")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("ol",[t("li",[t("code",[s._v("appender.rolling.type = RollingFile")]),s._v("：配置 "),t("code",[s._v("RollingFile")]),s._v(" 附加器")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_server.json")]),s._v("：记录日志到 "),t("code",[s._v("/var/log/elasticsearch/production_server.json")])]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.layout.type = ECSJsonLayout")]),s._v("：使用 JSON 布局")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.layout.dataset = elasticsearch.server")]),s._v("："),t("code",[s._v("dataset")]),s._v(" 是填充事件的标志。"),t("code",[s._v("ECSJsonLayout")]),s._v(" 中的数据集字段。它可以用于在解析日志时更容易地区分不同类型的日志。")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.json.gz")]),s._v("：将日志滚动到 "),t("code",[s._v("/var/log/lelasticsearch/production-yyyy-MM-dd-i.json")]),s._v("；日志将在每个卷上压缩，"),t("code",[s._v("i")]),s._v(" 将递增")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.policies.time.type = TimeBasedTriggeringPolicy")]),s._v("： 使用基于时间的滚动策略")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.policies.time.interval = 1")]),s._v("：每天滚动日志")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.policies.time.modulate = true")]),s._v("：在白天边界上对齐滚动（而不是每 24 小时滚动一次）")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.policies.size.type = SizeBasedTriggeringPolicy")]),s._v("：使用基于大小的滚动策略")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.policies.size.size = 256MB")]),s._v("：256 MB 后滚动日志")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.type = Delete")]),s._v("：滚动日志时使用删除操作")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.type = IfFileName")]),s._v("：仅删除与文件模式匹配的日志")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.glob = ${sys:es.logs.cluster_name}-*")]),s._v("：模式是只删除主日志")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.nested_condition.type = IfAccumulatedFileSize")]),s._v("：仅当我们累积了太多压缩日志时才删除")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.nested_condition.exceeds = 2GB")]),s._v("：压缩日志的大小条件为 2 GB")])]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("######## Server -  old style pattern ###########")]),s._v("\nappender.rolling_old.type = RollingFile\nappender.rolling_old.name = rolling_old\nappender.rolling_old.fileName = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("_server.log \nappender.rolling_old.layout.type = PatternLayout\nappender.rolling_old.layout.pattern = "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ISO8601"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("25c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%node_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("%marker %m%n\nappender.rolling_old.filePattern = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("yyyy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("MM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%i.old_log.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ol",[t("li",[t("code",[s._v("appender.rolling_old.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_server.log")]),s._v("："),t("code",[s._v("old style")]),s._v(" 附加器的配置。这些日志将保存在 "),t("code",[s._v("*.log")]),s._v(" 文件中，如果压缩，将在 "),t("code",[s._v("* .log.gz")]),s._v(" 文件中。请注意，这些应被视为已弃用，将来将被删除。")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("Log4j 的配置解析被任何无关的空格所混淆；如果复制并粘贴此页面上的任何 Log4j 设置，或输入任何 Log4j 配置，请确保删除任何前导和尾随空格。")])]),s._v(" "),t("p",[s._v("注意，在 "),t("code",[s._v("appender.rolling.filePattern")]),s._v(" 使用 "),t("code",[s._v(".zip")]),s._v(" 格式替代 "),t("code",[s._v(".gz")]),s._v(" 以通过 zip 格式压缩滚动日志。如果删除 "),t("code",[s._v(".gz")]),s._v(" 扩展名，则日志在滚动时不会被压缩。")]),s._v(" "),t("p",[s._v("如果要在指定的时间段内保留日志文件，可以使用滚动策略和删除操作。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("appender.rolling.strategy.type = DefaultRolloverStrategy \nappender.rolling.strategy.action.type = Delete \nappender.rolling.strategy.action.basepath = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \nappender.rolling.strategy.action.condition.type = IfFileName \nappender.rolling.strategy.action.condition.glob = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("* \nappender.rolling.strategy.action.condition.nested_condition.type = IfLastModified \nappender.rolling.strategy.action.condition.nested_condition.age = 7D \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ol",[t("li",[t("code",[s._v("appender.rolling.strategy.type = DefaultRolloverStrategy")]),s._v("：配置 "),t("code",[s._v("DefaultRolloverStrategy")])]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.type = Delete")]),s._v("：配置用于处理回滚的 "),t("code",[s._v("Delete")]),s._v(" 操作")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.basepath = ${sys:es.logs.base_path}")]),s._v("：Elasticsearch 日志的基本路径")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.type = IfFileName")]),s._v("：处理滚动时应用的条件")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.glob = ${sys:es.logs.cluster_name}-*")]),s._v("：从与 glob "),t("code",[s._v("${sys:es.logs.cluster_name}-*")]),s._v(" 匹配的基本路径中删除文件；这是日志文件滚动到的 glob；这不仅需要删除滚动的 Elasticsearch 日志，还需要删除弃用日志和慢日志")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.nested_condition.type = IfLastModified")]),s._v("：要应用于与 glob 匹配的文件的嵌套条件")]),s._v(" "),t("li",[t("code",[s._v("appender.rolling.strategy.action.condition.nested_condition.age = 7D")]),s._v("：日志保留七天")])]),s._v(" "),t("p",[s._v("可以加载多个配置文件（在这种情况下，它们将被合并），只要它们被命名为 "),t("code",[s._v("log4j2.properties")]),s._v("，并将 Elasticsearch 配置目录作为前驱；这对于暴露附加记录器的插件很有用。logger 部分包含 java 包及其相应的日志级别。appender 部分包含日志的目标。有关如何自定义日志记录和所有支持的附加程序的详细信息，可以在 "),t("a",{attrs:{href:"https://logging.apache.org/log4j/2.x/manual/configuration.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Log4j 文档"),t("OutboundLink")],1),s._v("中找到。")]),s._v(" "),t("h2",{attrs:{id:"配置日志级别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置日志级别"}},[s._v("#")]),s._v(" 配置日志级别")]),s._v(" "),t("p",[s._v("Elasticsearch 源代码中的每个 Java 包都有一个相关的记录器。例如，"),t("code",[s._v("org.elasticsearch.discovery")]),s._v(" 包有 "),t("code",[s._v("logger.org.elasticsearch.discovery")]),s._v(" 用于与"),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/discovery_and_cluster_formation/discovery.html"}},[s._v("发现")]),s._v("过程相关的日志。")],1),s._v(" "),t("p",[s._v("要获取更多或更少的详细日志，请使用"),t("RouterLink",{attrs:{to:"/rest_apis/cluster_apis/cluster_update_settings.html"}},[s._v("集群更新设置 API")]),s._v(" 更改相关记录器的日志级别。每个记录器都接受 Log4j 2 的内置日志级别，从最低到最详细："),t("code",[s._v("OFF")]),s._v("、"),t("code",[s._v("FATAL")]),s._v("、"),t("code",[s._v("ERROR")]),s._v("、"),t("code",[s._v("WARN")]),s._v("、"),t("code",[s._v("INFO")]),s._v("、"),t("code",[s._v("DEBUG")]),s._v(" 和 "),t("code",[s._v("TRACE")]),s._v("。默认日志级别为 "),t("code",[s._v("INFO")]),s._v("。以较高详细级别（"),t("code",[s._v("DEBUG")]),s._v(" 和 "),t("code",[s._v("TRACE")]),s._v("）记录的消息仅供专家使用。")],1),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("PUT /_cluster/settings\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"persistent"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"logger.org.elasticsearch.discovery"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"DEBUG"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("更改日志级别的其他方法包括：")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("elasticsearch.yml")]),s._v("：")])]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logger.org.elasticsearch.discovery")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DEBUG\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("在单个节点上调试问题时，这是最合适的。")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[t("code",[s._v("log4j2.properties")]),s._v("：")])]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("logger.discovery.name = org.elasticsearch.discovery\nlogger.discovery.level = debug\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("当你已经因为其他原因需要更改 Log4j 2 配置时，这是最合适的。例如，你可能希望将特定记录器的日志发送到另一个文件。然而，这些用例很少。")]),s._v(" "),t("h2",{attrs:{id:"弃用的日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#弃用的日志"}},[s._v("#")]),s._v(" 弃用的日志")]),s._v(" "),t("p",[s._v("Elasticsearch 还将弃用日志写入日志目录。当你使用已弃用的 Elasticsearch功能时，这些日志会记录一条消息。在将 Elasticsearch 升级到新的主要版本之前，你可以使用弃用日志来更新应用程序。")]),s._v(" "),t("p",[s._v("默认情况下，Elasticsearch 以 1GB 的速度滚动和压缩弃用日志。默认配置最多保留五个日志文件：四个滚动日志和一个活动日志。")]),s._v(" "),t("p",[s._v("Elasticsearch 在 "),t("code",[s._v("CRITICAL")]),s._v(" 级别发出弃用日志消息。这些消息表明，在下一个主要版本中将删除使用过的弃用功能。"),t("code",[s._v("WARN")]),s._v(" 级别的弃用日志消息表明使用了一个不太关键的功能，它不会在下一个主要版本中删除，但可能会在将来删除。")]),s._v(" "),t("p",[s._v("要停止写入弃用日志消息，请设置 "),t("code",[s._v("log4j2.properties")]),s._v(" 中的 "),t("code",[s._v("logger.deprevention.level")]),s._v(" 为 "),t("code",[s._v("OFF")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("logger.deprecation.level = OFF\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("或者，你可以动态更改日志记录级别：")]),s._v(" "),t("p",[s._v("参考"),t("RouterLink",{attrs:{to:"/set_up_elasticsearch/configuring_elasticsearch/logging.html#配置日志级别"}},[s._v("配置日志级别")])],1),s._v(" "),t("p",[s._v("如果 "),t("code",[s._v("X-Opaque-Id")]),s._v(" 用作 HTTP 头，你可以确定是什么触发了不推荐的功能。用户 ID 包含在弃用 JSON 日志的 "),t("code",[s._v("X-Opaque-ID")]),s._v(" 字段中。")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"type"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deprecation"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"timestamp"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2019-08-30T12:07:07,126+02:00"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"level"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"WARN"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"component"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"o.e.d.r.a.a.i.RestCreateIndexAction"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"cluster.name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"distribution_run"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"node.name"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node-0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[types removal] Using include_type_name in create index requests is deprecated. The parameter will be removed in the next major version."')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"x-opaque-id"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"MY_USER_ID"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"cluster.uuid"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Aq-c-PAeQiK3tfBYtig9Bw"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"node.id"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D7fUYfnfTLa2D7y-xw6tZg"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[t("code",[s._v("cluster.deprecation_indexing.enabled")]),s._v(" 设置被设置为 "),t("code",[s._v("true")]),s._v("，弃用日志可被索引到 "),t("code",[s._v(".logs-deprecation.elasticsearch-default")]),s._v(" 数据流。")]),s._v(" "),t("h2",{attrs:{id:"弃用日志限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#弃用日志限制"}},[s._v("#")]),s._v(" 弃用日志限制")]),s._v(" "),t("p",[s._v("弃用日志基于弃用的功能键和 "),t("code",[s._v("x-opaque-id")]),s._v(" 进行重复数据消除，这样，如果重复使用某个功能，则不会使弃用日志过载。这适用于索引的弃用日志和发送到日志文件的日志。通过将 "),t("code",[s._v("luster.deprecation_indexing.x_opaque_id_used.enabled")]),s._v(" 更改为 "),t("code",[s._v("false")]),s._v("，你可以禁用在节流中使用 "),t("code",[s._v("x-opaque-id")]),s._v("。参阅 "),t("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/server/src/main/java/org/elasticsearch/common/logging/RateLimitingFilter.java",target:"_blank",rel:"noopener noreferrer"}},[s._v("RateLimitingFilter"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"json-日志格式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#json-日志格式"}},[s._v("#")]),s._v(" JSON 日志格式")]),s._v(" "),t("p",[s._v("为了更容易解析 Elasticsearch 日志，日志现在以 JSON 格式打印。这由 Log4J 布局属性 "),t("code",[s._v("appender.rolling.layout.type=ECSJsonLayout")]),s._v(" 配置。此布局需要设置数据集属性，该属性用于在分析时区分日志流。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("appender.rolling.layout.type = ECSJsonLayout\nappender.rolling.layout.dataset = elasticsearch.server\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("每行包含一个 JSON 文档，属性在 "),t("code",[s._v("ECSJsonLayout")]),s._v(" 中配置。有关详细信息，参阅此类 "),t("a",{attrs:{href:"https://artifacts.elastic.co/javadoc/org/elasticsearch/elasticsearch/8.5.3/org/elasticsearch/common/logging/ESJsonLayout.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("javadoc"),t("OutboundLink")],1),s._v("。但是，如果 JSON 文档包含异常，则将在多行上打印。第一行将包含常规属性，随后的行将包含格式化为 JSON 数组的堆栈跟踪。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("你仍然可以使用自己的自定义布局。为此，使用不同的布局替换行 "),t("code",[s._v("appender.rolling.layout")]),s._v("。参见以下示例：")])]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("appender.rolling.type = RollingFile\nappender.rolling.name = rolling\nappender.rolling.fileName = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("_server.log\nappender.rolling.layout.type = PatternLayout\nappender.rolling.layout.pattern = "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ISO8601"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("25c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("%node_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("%marker %."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("10000m%n\nappender.rolling.filePattern = $"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.base_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("file.separator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("es.logs.cluster_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%d"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("yyyy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("MM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("%i.log.gz\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("blockquote",[t("p",[t("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/logging.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("原文链接"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);