(window.webpackJsonp=window.webpackJsonp||[]).push([[97],{375:function(e,t,a){"use strict";a.r(t);var _=a(13),s=Object(_.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"knn-搜索-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#knn-搜索-api"}},[e._v("#")]),e._v(" kNN 搜索 API")]),e._v(" "),t("div",{staticClass:"custom-block danger"},[t("p",{staticClass:"custom-block-title"},[e._v("警告")]),e._v(" "),t("p",[e._v("此功能在技术预览版中，可能会在未来的版本中更改或删除。Elastic将尽最大努力解决任何问题，但技术预览中的功能不受正式 GA 功能的支持 SLA 的约束。")])]),e._v(" "),t("p",[e._v("执行 k-最近邻（k-nearest neighbor,kNN）搜索并返回匹配的文档。")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("GET my-index/_knn_search\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"knn"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"field"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"image_vector"')]),e._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"query_vector"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.3")]),e._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.1")]),e._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1.2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"k"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"num_candidates"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"_source"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"name"')]),e._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"date"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br")])]),t("h2",{attrs:{id:"请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#请求"}},[e._v("#")]),e._v(" 请求")]),e._v(" "),t("p",[t("code",[e._v("GET <target>/_knn_search")])]),e._v(" "),t("p",[t("code",[e._v("POST <target>/_knn_search")])]),e._v(" "),t("h2",{attrs:{id:"前置条件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前置条件"}},[e._v("#")]),e._v(" 前置条件")]),e._v(" "),t("ul",[t("li",[e._v("如果 Elasticsearch 安全特性启用，你对目标数据流、索引或别名必须有"),t("a",{attrs:{href:"/secure_the_elastic_statck/user_authorization/security_privileges#%E7%B4%A2%E5%BC%95%E6%9D%83%E9%99%90"}},[e._v("索引权限")]),e._v("。")])]),e._v(" "),t("h2",{attrs:{id:"描述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#描述"}},[e._v("#")]),e._v(" 描述")]),e._v(" "),t("p",[e._v("kNN 搜索 API 在 "),t("a",{attrs:{href:"/mapping/dense_vector"}},[t("code",[e._v("dense_vector")])]),e._v(" 字段上执行 k-最近邻（kNN）搜索。给定一个查询向量，它会找到 "),t("code",[e._v("k")]),e._v(" 个最接近的向量，并将这些文档作为搜索结果返回。")]),e._v(" "),t("p",[e._v("Elasticsearch 使用 "),t("a",{attrs:{href:"https://arxiv.org/abs/1603.09320",target:"_blank",rel:"noopener noreferrer"}},[e._v("HNSW 算法"),t("OutboundLink")],1),e._v("来支持高效的 kNN 搜索。与大多数 kNN 算法一样，HNSW 是一种近似方法，它牺牲了结果的准确性以提高搜索速度。这意味着返回的结果并不总是真正的 "),t("code",[e._v("k")]),e._v(" 近邻。")]),e._v(" "),t("h2",{attrs:{id:"路径参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#路径参数"}},[e._v("#")]),e._v(" 路径参数")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("<target>")])]),e._v(" "),t("p",[e._v("（可选，字符串）限制请求的逗号分隔的数据流、索引和别名的列表。支持通配符（*）。要以所有数据流和索引为目标，忽略此参数或使用 "),t("code",[e._v("*")]),e._v(" 或 "),t("code",[e._v("_all")]),e._v("。")]),e._v(" "),t("div",{staticClass:"custom-block danger"},[t("p",{staticClass:"custom-block-title"},[e._v("警告")]),e._v(" "),t("p",[e._v("kNN 搜索还不能处理"),t("a",{attrs:{href:"/aliases#%E8%BF%87%E6%BB%A4%E7%9A%84%E5%88%AB%E5%90%8D"}},[e._v("过滤的别名")]),e._v("。对过滤后的别名运行 kNN 搜索可能会错误地导致少于 "),t("em",[e._v("k")]),e._v(" 次点击。")])])])]),e._v(" "),t("h2",{attrs:{id:"查询参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查询参数"}},[e._v("#")]),e._v(" 查询参数")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("routing")])]),e._v(" "),t("p",[e._v("（可选，字符串）用于路由操作到指定分片的自定义值。")])])]),e._v(" "),t("h2",{attrs:{id:"请求体"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#请求体"}},[e._v("#")]),e._v(" 请求体")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("knn")])]),e._v(" "),t("p",[e._v("（必需，对象）定义运行的 kNN 查询。")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("knn")]),e._v(" 对象属性")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("field")])]),e._v(" "),t("p",[e._v("（必需，字符串）要搜索的向量字段的名称。必须是"),t("a",{attrs:{href:"/mapping/dense_vector#kNN-%E6%90%9C%E7%B4%A2%E7%9A%84%E7%B4%A2%E5%BC%95%E5%90%91%E9%87%8F"}},[e._v("启用索引的 dense_vector")]),e._v("。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("query_vector")])]),e._v(" "),t("p",[e._v("（必需，浮点数组）查询向量。必须与要搜索的向量场具有相同的维数。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("k")])]),e._v(" "),t("p",[e._v("（必需，整数）作为优先命中返回的最近邻居数。值必须小于 "),t("code",[e._v("num_candidates")]),e._v("。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("num_candidates")])]),e._v(" "),t("p",[e._v("（必需，整数）每个分片要考虑的最近邻候选数。不能超过 10,000。Elasticsearch 从每个分片中收集 "),t("code",[e._v("num_candidates")]),e._v(" 个结果，然后合并它们以找到前 "),t("code",[e._v("k")]),e._v(" 个结果。增加 "),t("code",[e._v("num_candidates")]),e._v(" 往往会提高最终 "),t("code",[e._v("k")]),e._v("结果的准确性。")])])])])])]),e._v(" "),t("li",[t("p",[t("code",[e._v("docvalue_fields")])]),e._v(" "),t("p",[e._v("（可选，字符串和对象数组）通配符（*）模式数组。该请求返回响应的 "),t("code",[e._v("hits.fields")]),e._v(" 属性中与这些模式匹配的字段名的文档值。")]),e._v(" "),t("p",[e._v("你可以在数组中指定字符串或对象。参阅"),t("a",{attrs:{href:"/search_your_data/retrieve_selected_fields#%E6%96%87%E6%A1%A3%E5%80%BC%E5%AD%97%E6%AE%B5"}},[e._v("文档值字段")]),e._v("。")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("docvalue_fields")]),e._v(" 对象属性")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("field")])]),e._v(" "),t("p",[e._v("（必需，字符串）通配符模式。请求返回与此模式匹配的字段名的文档值。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("format")])]),e._v(" "),t("p",[e._v("（可选，字符串）返回文档值的格式。")]),e._v(" "),t("p",[e._v("对于"),t("a",{attrs:{href:"/mapping/field_data_types/date"}},[e._v("日期字段")]),e._v("，你可以指定日期的"),t("a",{attrs:{href:"/mapping/mapping_parameters/format"}},[e._v("日期格式")]),e._v("。对于"),t("a",{attrs:{href:"/mapping/field_data_types/numeric"}},[e._v("数字字段")]),e._v("，你可以指定"),t("a",{attrs:{href:"https://docs.oracle.com/javase/8/docs/api/java/text/DecimalFormat.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("十进制模式"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("p",[e._v("对于其他字段数据类型，此参数不支持。")])])])])])]),e._v(" "),t("li",[t("p",[t("code",[e._v("fields")])]),e._v(" "),t("p",[e._v("（可选，字符串和对象数组）通配符（*）模式数组。该请求返回响应的 "),t("code",[e._v("hits.fields")]),e._v(" 属性中与这些模式匹配的字段名的文档值。")]),e._v(" "),t("p",[e._v("你可以在数组中指定字符串或对象。")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("fields")]),e._v(" 对象属性")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("field")])]),e._v(" "),t("p",[e._v("（必需，字符串）返回的字段。支持通配符（*）。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("format")])]),e._v(" "),t("p",[e._v("（可选，字符串）日期和地理空间字段的格式。其他字段数据类型不支持此参数。")]),e._v(" "),t("p",[t("a",{attrs:{href:"/mapping/field_data_types/date"}},[t("code",[e._v("date")])]),e._v(" 和 "),t("a",{attrs:{href:"/mapping/field_data_types/date_nanoseconds"}},[t("code",[e._v("date_nanos")])]),e._v(" 字段接受"),t("a",{attrs:{href:"/mapping/mapping_parameters/format"}},[e._v("日期格式")]),e._v("。"),t("a",{attrs:{href:"/mapping/field_data_types/geopoint"}},[t("code",[e._v("geo_point")])]),e._v(" 和 "),t("a",{attrs:{href:"/mapping/field_data_types/geoshape"}},[t("code",[e._v("geo_shape")])]),e._v(" 字段接受：")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("geojson")]),e._v("（默认）")]),e._v(" "),t("p",[t("a",{attrs:{href:"http://www.geojson.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("GeoJSON"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("code",[e._v("wkt")])]),e._v(" "),t("p",[t("a",{attrs:{href:"https://en.wikipedia.org/wiki/Well-known_text_representation_of_geometry",target:"_blank",rel:"noopener noreferrer"}},[e._v("Well Known Text/知名文本"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("code",[e._v("mvt(<zoom>/<x>/<y>@<extent>) or mvt(<zoom>/<x>/<y>)")])]),e._v(" "),t("p",[e._v("地图盒矢量块。此 API 返回的块是 base64 编码的字符串。")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("mvt")]),e._v(" 参数\n"),t("ul",[t("li",[t("p",[t("code",[e._v("<zoom>")])]),e._v(" "),t("p",[e._v("（必需，整数）块的缩放级别。支持 "),t("code",[e._v("0")]),e._v("-"),t("code",[e._v("29")]),e._v("。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("<x>")])]),e._v(" "),t("p",[e._v("（必需，整数）块的 X 坐标。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("<y>")])]),e._v(" "),t("p",[e._v("（必需，整数）块的 Y 坐标。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("<extent>")])]),e._v(" "),t("p",[e._v("（可选，整数）平铺一侧的大小（以像素为单位）。矢量平铺是等边的正方形。默认为 "),t("code",[e._v("4,096")]),e._v("。")])])])])])])])])])])])]),e._v(" "),t("li",[t("p",[t("code",[e._v("_source")])]),e._v(" "),t("p",[e._v("（可选）指示为匹配文档返回的"),t("a",{attrs:{href:"/mapping/metadata_fields/_source-field"}},[e._v("源字段")]),e._v("。这些字段将在搜索响应的属性 "),t("code",[e._v("hits._source")]),e._v(" 中返回。默认为 "),t("code",[e._v("true")]),e._v("。")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("_source")]),e._v(" 有效值")]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("true")])]),e._v(" "),t("p",[e._v("（布尔值）全部文档源返回。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("false")])]),e._v(" "),t("p",[e._v("（布尔值）文档源不返回。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("<string>")])]),e._v(" "),t("p",[e._v("（字符串）逗号分隔的待返回的源字段列表。支持通配符（*）。")])])])])])]),e._v(" "),t("li",[t("p",[t("code",[e._v("stored_fields")])]),e._v(" "),t("p",[e._v("（可选，字符串）以逗号分隔的存储字段列表，作为命中的一部分返回。如果未指定字段，则响应中不包括存储的字段。")]),e._v(" "),t("p",[e._v("如果指定了此字段，则 "),t("code",[e._v("_source")]),e._v(" 参数默认为 "),t("code",[e._v("false")]),e._v("。你可以传递 "),t("code",[e._v("_source:true")]),e._v(" 以返回搜索响应中的源字段和存储字段。")])])]),e._v(" "),t("h2",{attrs:{id:"响应体"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#响应体"}},[e._v("#")]),e._v(" 响应体")]),e._v(" "),t("p",[e._v("kNN 搜索响应的结构与"),t("a",{attrs:{href:"/rest_apis/search_apis/search#%E5%93%8D%E5%BA%94%E4%BD%93"}},[e._v("搜索 API 响应")]),e._v("的结构完全相同。但是，某些部分对 kNN 搜索有特定的含义：")]),e._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"/rest_apis/search_apis/search#%E5%93%8D%E5%BA%94%E4%BD%93"}},[e._v("文档 _score")]),e._v("由查询和文档向量之间的相似性决定。参阅"),t("a",{attrs:{href:"/mapping/dense_vector#%E7%A8%A0%E5%AF%86%E5%90%91%E9%87%8F%E5%9C%BA%E7%9A%84%E5%8F%82%E6%95%B0"}},[e._v("相似性")]),e._v("。")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("hits.total")]),e._v(" 对象包含考虑的最近邻候选总数，即 "),t("code",[e._v("num_candidates * num_shards")]),e._v("。"),t("code",[e._v("hits.total.relation")]),e._v(" 总是 "),t("code",[e._v("eq")]),e._v("，表示精确的值。")])])]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/knn-search-api.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("原文链接"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=s.exports}}]);